% Load the kaobook class
\documentclass[
    a4paper, % Page size
    fontsize=10pt, % Base font size
    twoside=true, % Use different layouts for even and odd pages (in particular, if twoside=true, the margin column will be always on the outside)
    %open=any, % If twoside=true, uncomment this to force new chapters to start on any page, not only on right (odd) pages
    %chapterentrydots=true, % Uncomment to output dots from the chapter name to the page number in the table of contents
    numbers=noenddot, % Comment to output dots after chapter numbers; the most common values for this option are: enddot, noenddot and auto (see the KOMAScript documentation for an in-depth explanation)
    fontmethod=tex,
]{kaobook}

\ifxetexorluatex
    \usepackage{polyglossia}
    \setmainlanguage{english}
\else
    \usepackage[english]{babel}
\fi
\usepackage[english=american]{csquotes}
\setcounter{tocdepth}{1}
\usepackage{orcidlink}
\usepackage{siunitx}
\usepackage{astro}

\usepackage[backend=biber, style=numeric-comp,backref, sorting=none, firstinits=true]{biblatex}

% Hack to include Collaboration author field
\DeclareSourcemap{
 \maps[datatype=bibtex,overwrite=true]{
  \map{
    \step[fieldsource=Collaboration, final=true]
    \step[fieldset=usera, origfieldval, final=true]
  }
 }
}

\renewbibmacro*{author}{%
  \iffieldundef{usera}{%
    \printnames{author}%
  }{%
    \printfield{usera}, \printnames{author}%
  }%
}%

\usepackage{kaobiblio}
\addbibresource{thesis.bib}

\usepackage[framed=true]{kaotheorems}
\usepackage{kaorefs}

\graphicspath{{figures/}{images/}}

\makeindex[columns=3, title=Alphabetical Index, intoc]


\begin{document}

%----------------------------------------------------------------------------------------
%   BOOK INFORMATION
%----------------------------------------------------------------------------------------
\subject{Doctoral Thesis}
% \titlehead{Optical Follow-Up of High-Energy Neutrinos}
\title[Optical Follow-Up of High-Energy Neutrinos]{Optical Follow-Up of High-Energy Neutrinos}
\author[SR]{Simeon Reusch}% \orcidlink{0000-0002-7788-628X}}
\date{\today}
\publishers{Humboldt-Universit√§t zu Berlin}

%----------------------------------------------------------------------------------------

\frontmatter

\makeatletter
\uppertitleback{\@titlehead}

\lowertitleback{
    \textbf{Copyright} \\
    \cczero\ This book is released into the public domain using the CC0 code. To the extent possible under law, I waive all copyright and related or neighbouring rights to this work. To view a copy of the CC0 code, visit: \\\url{http://creativecommons.org/publicdomain/zero/1.0}
    
    \medskip
 
    This thesis was typeset with the help of \href{https://sourceforge.net/projects/koma-script}{\KOMAScript} and \href{https://www.latex-project.org}{\LaTeX} using the \href{https://github.com/fmarotta/kaobook}{kaobook} class.
    
    \medskip

    The code used to typeset this thesis and create the figures within can be accessed at \href{https://github.com/simeonreusch/koma-thesis}{github.com/simeonreusch/thesis}

    \medskip
    
    \textbf{Publisher} \\
    First published in August 2023 by \@publishers
}
\makeatother


\maketitle

\begingroup % Local scope for the following commands

% Define the style for the TOC, LOF, and LOT
%\setstretch{1} % Uncomment to modify line spacing in the ToC
%\hypersetup{linkcolor=blue} % Uncomment to set the colour of links in the ToC
\setlength{\textheight}{230\vscale} % Manually adjust the height of the ToC pages

% Turn on compatibility mode for the etoc package
%\etocstandarddisplaystyle % "toc display" as if etoc was not loaded
%\etocstandardlines % "toc lines as if etoc was not loaded

\tableofcontents
\listoffigures

\let\cleardoublepage\bigskip
\let\clearpage\bigskip

\listoftables

\endgroup

\mainmatter
\setchapterstyle{kao}

%\chapter{Theoretical background}
%\addpart{Title of the Part}
\pagelayout{margin}



\input{chapters/icecube.tex}
\input{chapters/ztf.tex}
\setchapterimage[7cm]{fu/heading3.png}
\chapter{The ZTF Follow-Up Pipeline} 
\labch{fupipeline}
After introducing the IceCube detector (see chapter \ref{ic}) and the Zwicky Transient Facility (see chapter \ref{ztf}), we now have all the ingredients to introduce the ZTF high-energy neutrino follow-up pipeline.

IceCube sends out \num{\sim2.2} astrophysical high-energy neutrino alerts on average per month (see section \ref{ic_alerts}). Due to its large FoV and fully robotic operation, ZTF is the ideal follow-up instrument for these alerts. The typically reported IceCube localization regions can be covered with only one pointing of the telescope.

The follow-up procedure can be outlined as follows: An \textit{IceCube alert} is received. If the alert meets our \textit{alert quality criteria}, we do an \textit{observability check}. If the sky region is accessible to ZTF, we \textit{observe}. After observations, we \textit{filter} candidates with \texttt{AMPEL} \sidecite{Nordin2019}, followed by visual inspection and -- if needed -- trigger \textit{additional follow-up}.

\section{Alert cuts}\label{alert_cuts}
As we only have limited telescope time, we apply quality cuts on the high-energy neutrino alerts received via GCN. As outlined in section \ref{ic_event_selection}, there are two alert streams: \textit{Gold alerts} with an average purity of \SI{50}{\percent} (\SI{36}{\percent} of all non-retracted alerts), and \textit{bronze alerts} with an average purity of \SI{30}{\percent} (\SI{64}{\percent}).

In general, we only follow up if the reported rectangular \SI{90}{\percent} uncertainty region is smaller than \SI{40}{\square\deg}. All gold alerts making this cut qualify for follow up. There is a more stringent cut on the uncertainty area of bronze alerts, requiring these are $<\SI{10}{\square\deg}$.

\section{Observation planning with \texttt{planobs}}\label{planobs}
If an alert makes the cut, one needs to check if observations with ZTF are feasible. To reduce the potential for errors, this is done with assistance by the \texttt{planobs} \sidecite{Reusch2023} tool, developed mainly by the author to automate the task as much as possible.

\texttt{planobs} is written in Python, and is deployed on a virtual private server. The backend runs on \texttt{Flask}\sidenote{\url{https://flask.palletsprojects.com}} behind a \texttt{nginx}\sidenote{\url{https://nginx.com}} reverse proxy and serves a Slack\sidenote{\url{https://slack.com/}} bot integrated into the DESY multimessenger group chat.

The tool is constructed to be used with a simple command-line-style interface in the Slack chat. For example, 
\begin{lstlisting}[language=bash,style=kaolstplain]
Plan IC221223A -multiday
\end{lstlisting}
will create an observation plan for IceCube high-energy neutrino IC220501A, spanning multiple days.

To obtain the positional and error information on the neutrino in question from the respective GCN circular, \texttt{planobs} is searching for the GCN on an experimental server\sidenote{\url{https://heasarc.gsfc.nasa.gov/wsgi-scripts/tach/gcn_v2/tach.wsgi}}. As notices are written by humans, it fuzzily parses them to extract the relevant information. After this, observability at Mt. Palomar is calculated, defaulting to the current time (optionally, a desired observation time can be requested). 

\begin{figure}[h!]
    \includegraphics{fu/planobs_airmass.pdf}
    \caption[Observation plan]{Observation plot created by \texttt{planobs} for the follow-up of IceCube neutrino IC221223A. The altitude and airmass of the alert region at Mt. Palomar are shown in blue. The red and green shaded regions are proposed observation windows in the \textit{r}- and \textit{r}-band. The red arrows show the airmass limit of 2.0, and the moon is displayed as yellow dotted curve. The gray shaded region marks night-time at the telescope site. All information automatically extracted from the GCN circular are shown on top.}
    \labfig{planobs}
\end{figure}
\begin{marginfigure}
    \includegraphics{fu/planobs_grid.pdf}
    \caption[\texttt{planobs} ZTF grid]{The \SI{90}{\percent} uncertainty rectangle of IC221223A overlayed onto the ZTF grid.}
    \labfig{planobs_grid}
\end{marginfigure}
An example observability plot is shown in Fig. \ref{fig:planobs}. The blue curve shows the altitude of the sky region in question above Mt. Palomar, and the red and green shaded regions mark the two proposed observation windows in the \textit{r}- and the \textit{g}-band.

Additionally, for each field within the primary and secondary grid (see section \ref{ztf_grid}) that have overlap with the uncertainty region\sidenote{There is an additional check to ensure the fields have reference images available, see section \ref{ztf_image_subtraction}.}, the coverage is calculated and the field with the highest coverage is selected. Fig. \ref{fig:planobs_grid} shows such an overlay plot for IC221223A and ZTF field 693.

If the plan looks good, one needs to invoke
\begin{lstlisting}[language=bash,style=kaolstplain]
Plan IC221223A -trigger
\end{lstlisting} 
to submit the observation request via a dedicated API to the telescope scheduler. There is additional functionality to ensure that the trigger has been added to the telescope queue. If all goes well and weather permits, the observations are carried out, and candidate vetting can begin.

As we are interested in the evolution of potential source candidates, usually observations within a \SI{10}{\day} window are triggered. To obtain deep images during the first night, we trigger \SI{300}{\second} exposures in the \textit{g}- and \textit{r}-band in the first night. These are followed by shallower \SI{30}{\second} observations in the \textit{g}-band during nights 2, 3, 5 and 7, and finally shallow observations in both \textit{g}- and \textit{r}-band during night 9.

\section{The \texttt{AMPEL} broker} \label{ampel}
The next step in the pipeline is the selection of good candidates. ZTF typically serves 200000 alerts per night. As only a fraction of those is relevant for the neutrino follow up, we need software to cut down the number of alerts. This is exactly what AMPEL is doing, a streaming data analysis framework developed at Humboldt-University Berlin and DESY Zeuthen with contribution of the author.

The main design goals of \texttt{AMPEL} comprise scalability, modularity and provenance tracking. It was built with the data rate of future Rubin observatory \sidecite{Ivezic2019} in mind, and was subsequently selected as one of 7 brokers\sidenote{See \url{https://www.lsst.org/scientists/alert-brokers}.} for Rubin observatory. The complete software stack is written in Python.


\begin{figure}[h!]
    \includegraphics{fu/ampel_design.pdf}
    \caption[\texttt{AMPEL} overview]{Overview of the \texttt{AMPEL} data processing. Alerts from DiRAC are ingested into \texttt{AMPEL}, where they are processed, combined, analyzed and served to science consumers. From \cite{Nordin2019}}
    \labfig{ampel_design}
\end{figure}

Fig. \ref{fig:ampel_design} shows the design and information flow of \texttt{AMPEL}. On the top, data from Mt. Palomar is transmitted to IPAC (see section \ref{ztf_data_link}), where detections are extracted from the difference images. These are then sent to the Institute for Data Intensive Research in Astrophysics \& Cosmology (DiRAC) at the University of Washington, where they are distributed via parallel Kafka streams. This is the live data stream \texttt{AMPEL} listens to.

The first of several execution layers (\textit{tiers}) is the \textbf{Filtering} stage (Tier 0). Here different filters can be implemented, reducing the large number of alerts by different criteria. These comprise e.g. \texttt{RealBogus} and \texttt{sgscore} (see section \ref{ztf_image_subtraction}), color evolution, host galaxy properties and the (non-) existence of detection history. All alerts surviving the filtering stage are then stored in a \texttt{MongoDB}\sidenote{\url{https://mongodb.com}} database collection. Additionally, processing states are also stored in another collection.

\textbf{Tier 1} can be skipped here, as it serves technical purposes. The next relevant stage is the \textbf{Light curve nalysis} stage (Tier 2). Here, additional information on the transients are either obtained or generated. Possible steps are querying external catalogs for host galaxy or redshift information, fitting lightcurves with various models or ML-based photometric classification.

The last level, tier 3, executes \textbf{Population analysis}. These are schedulable actions, triggered on request or at pre-defined times (ranging from yearly data dumps, through daily updates to nearly real-time execution). A typical use case is the automated ranking of different transients for a specific science goal. An example is the daily posting of new supernova candidates in a Slack channel, ranked by how interesting they are for spectroscopic follow up \cite{Nordin2019}.

To simplify matters and allow reprocessing as well as full replayability, all ZTF alerts received via the Kafka streams since June 2018 are also stored in an archival alert database hosted at DESY\sidenote{\url{https://ampel.zeuthen.desy.de/api/ztf/archive/v3/docs}}. The database is \texttt{Postgresql}\sidenote{\url{https://postgresql.org/}} and can be accessed with a web frontend and an API.

\section{Candidate filtering with \texttt{nuztf}}
To streamline the neutrino follow-up process, \texttt{nuztf} \sidecite{Stein2023} was created for filtering and inspecting candidate counterparts, with heavy contribution by the author. When run, it executes the following steps: It obtains the IceCube alert information from the GCN, constructs a \texttt{HEALPix} map from the \SI{90}{\percent} uncertainty rectangle, queries the \texttt{AMPEL} archive (see section \ref{ampel}) for all alerts within the \texttt{HEALPix} map\sidenote{Due to the \texttt{HEALPix}-based indexing scheme, this is much faster than a cone search.} in a given time range, applies the \texttt{AMPEL} \texttt{DecentFilter} \cite{Nordin2019} with custom parameters (see below) on these, crossmatches the surviving counterpart candidates to a list of catalogs, and finally creates an overview pdf file detailing each candidate.

\subsection{\texttt{DecentFilter} parameters}
The GCN parsing is done akin to \texttt{planobs} (see section \ref{planobs}). After extraction of the alert information and querying the Archive database with a \texttt{HEALPix} map, \texttt{DecentFilter} is run with the following parameters:
\begin{description}
    \item[Time window] The transient must have shown activity in a \SI{14}{\day} window after neutrino detection
\end{description}

%\chapter{Candidate TDE AT2019fdr: a possible source?}
%\chapter{The ZTF nuclear sample}
%\chapter{Conclusion and Outlook}
\appendix

\pagelayout{wide} % No margins
\addpart{Appendix}
\pagelayout{margin} % Restore margins
\begin{table*}
%\renewcommand{\arraystretch}{1.1}
\centering
\small
    \begin{tabular}{l r r r r r c} 
        \textbf{Event} & \textbf{R.A. (J2000)} & \textbf{Dec (J2000)} & \textbf{90\% area} & \textbf{ZTF obs} &~ \textbf{Signal-}& \textbf{Reference}\\
        & \textbf{(deg)}&\textbf{(deg)}& \textbf{(deg$^{2}$)}& \textbf{(deg$^{2}$)} & \textbf{ness} &\\
        \hline
        IC190503A & $120.28$ & $6.35$ & 1.94 & 1.37 & 36\%&\cite{IC190503A1, IC190503A2}\\
        IC190619A & $343.26$ & $10.73$ & 27.21 & 21.57 & 55\%&\cite{IC190619A1, IC190619A2}\\
        IC190730A & $225.79$ & $10.47$ & 5.41 & 4.52 & 67\%&\cite{IC190730A1, IC190730A2}\\
        IC190922B & $5.76$ & $-1.57$ & 4.48 & 4.09 & 51\%&\cite{IC190922B1, IC190922B2, IC190922B3}\\
        IC191001A & $314.08$ & $12.94$ & 25.53 & 23.06 & 59\%& \cite{IC191001A1, IC191001A2, IC191001A3}\\
        IC200107A & $148.18$ & $35.46$ & 7.62 & 6.28 & -- &\cite{IC200107A1, IC200107A2}\\
        IC200109A & $164.49$ & $11.87$ & 22.52 & 22.36 & 77\%&\cite{IC200109A1, IC200109A2}\\
        IC200117A & $116.24$ & $29.14$ & 2.86 &  2.66 & 38\%&\cite{IC200117A1, IC200117A2, IC200117A3}\\
        IC200512A & $295.18$ & $15.79$ & 9.77 &  9.26 & 32\%&\cite{IC200512A1, IC200512A2}\\
        \textbf{IC200530A} & \textbf{255.37} & \textbf{26.61} & \textbf{25.38} &  \textbf{22.05} & \textbf{59\%}&\cite{IC200530A1, IC200530A2, IC200530A3, IC200530A4}\\
        IC200620A & $162.11$ & $11.95$ & 1.73 & 1.24 & 32\%&\cite{IC200620A1, IC200620A2}\\
        IC200916A & $109.78$ & $14.36$ & 4.22 & 3.61 & 32\%&\cite{IC200916A1, IC200916A2, IC200916A3}\\
        IC200926A & $96.46$ & $-4.33$ & 1.75 & 1.29 & 44\%&\cite{IC200926A1, IC200926A2}\\
        IC200929A & $29.53$ & $3.47$ & 1.12 & 0.87 & 47\%&\cite{IC200929A1, IC200929A2}\\
        IC201007A & $265.17$ & $5.34$ & 0.57 & 0.55 & 88\%&\cite{IC201007A1, IC201007A2}\\
        IC201021A & $260.82$ & $14.55$ & 6.89 & 6.30 & 30\%&\cite{IC201021A1, IC201021A2}\\
        IC201130A & 30.54 & $-12.1$ & 5.44 & 4.51 & 15\%&\cite{IC201130A1, IC201130A2}\\
        IC201209A & $6.86$ & $-9.25$ & 4.71 & 3.20 & 19\%&\cite{IC201209A1, IC201209A2}\\
        IC201222A & $206.37$ & $13.44$ & 1.54 & 1.40 & 53\%&\cite{IC201222A1, IC201222A2}\\
        IC210210A & $206.06$ & $4.78$ & 2.76 & 2.05 & 65\%&\cite{IC210210A1, IC210210A2}\\
        IC210510A & $268.42$ & $3.81$ & 4.04 & 3.67 & 28\%&\cite{IC210510A1, IC210510A2}\\
        IC210629A & $340.75$ & $12.94$ & 5.99 & 4.59 & 35\%&\cite{IC210629A1, IC210629A2}\\
        IC210811A & $270.79$ & $25.28$ & 3.17 & 2.66 & 66\%&\cite{IC210811A1, IC210811A2}\\
        IC210922A & $60.73$ & $25.28$ & -4.18 & 1.16 & 93\%&\cite{IC210922A1, IC210922A2}\\
    \end{tabular}
    \caption{Summary of the 24 neutrino alerts followed up by ZTF until September 2021, with IC200530A highlighted. The 90\% area column indicates the rectangular uncertainty region of sky as reported by IceCube. The ZTF obs column indicates the area observed at least twice by ZTF, within the reported 90\% localization (accounting for chip gaps). \textit{Signalness} estimates the probability that the neutrino is of astrophysical origin, rather than caused by atmospheric background. The total followed-up area (corrected for chip-gaps) is 154.33 deg$^{2}$. }
    \label{tab:neutrino_alert_overview}
\end{table*}

%----------------------------------------------------------------------------------------

\backmatter % Denotes the end of the main document content
\setchapterstyle{plain} % Output plain chapters from this point onwards 

%----------------------------------------------------------------------------------------
%   BIBLIOGRAPHY
%----------------------------------------------------------------------------------------

% The bibliography needs to be compiled with biber using your LaTeX editor, or on the command line with 'biber main' from the template directory
%\defbibnote{bibnote}{Here are the references in citation order.\par\bigskip} % Prepend this text to the bibliography
\printbibliography[heading=bibintoc, title=Bibliography] % Add the bibliography heading to the ToC, set the title of the bibliography and output the bibliography note


\printindex % Output the index

\end{document}
